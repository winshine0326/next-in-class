# TanStack Queryë¥¼ ì‚¬ìš©í•œ Next.js ê²Œì‹œíŒ CRUD êµ¬í˜„ ê°€ì´ë“œ

ì´ ê°€ì´ë“œëŠ” Next.js App Routerì™€ TanStack Queryë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ëŒ€ì ì¸ ê²Œì‹œíŒ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬í˜„í•˜ëŠ” ë‹¨ê³„ë³„ íŠœí† ë¦¬ì–¼ì…ë‹ˆë‹¤. ì´ˆë³´ìë„ ë”°ë¼í•  ìˆ˜ ìˆë„ë¡ ì‹¤ì œ êµ¬í˜„ ì½”ë“œì™€ í•¨ê»˜ ì„¤ëª…í•©ë‹ˆë‹¤.

## ğŸ¯ í•™ìŠµ ëª©í‘œ
- TanStack Queryì˜ ê¸°ë³¸ ê°œë… ì´í•´
- Next.js App Routerì—ì„œ í´ë¼ì´ì–¸íŠ¸/ì„œë²„ ì»´í¬ë„ŒíŠ¸ ë¶„ë¦¬
- ì„ ì–¸ì  ë°ì´í„° íŒ¨ì¹­ê³¼ ìƒíƒœ ê´€ë¦¬
- CRUD ê¸°ëŠ¥ êµ¬í˜„ (ìƒì„±, ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œ)
- ë¡œë”©/ì—ëŸ¬ ìƒíƒœ ì²˜ë¦¬

---

## 1ë‹¨ê³„: íŒ¨í‚¤ì§€ ì„¤ì¹˜

### í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
```bash
npm i @tanstack/react-query @tanstack/query-core
```

### DevTools ì„¤ì¹˜ (ê°œë°œ í¸ì˜)
```bash
npm i @tanstack/react-query-devtools
```

### Error Boundary ì„¤ì¹˜ (ì—ëŸ¬ ì²˜ë¦¬)
```bash
npm i react-error-boundary
```

### ì„¤ì¹˜ í™•ì¸
`package.json`ì— ë‹¤ìŒ ì˜ì¡´ì„±ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”:
```json
{
  "dependencies": {
    "@tanstack/react-query": "^5.x.x",
    "@tanstack/query-core": "^5.x.x",
    "@tanstack/react-query-devtools": "^5.x.x",
    "react-error-boundary": "^4.x.x"
  }
}
```

**ğŸ’¡ íŒ**: ê°œë°œ í¸ì˜ë¥¼ ìœ„í•´ ë‹¤ìŒë„ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
npm i -D @tanstack/eslint-plugin-query
```

---

## 2ë‹¨ê³„: QueryProvider ì„¤ì •

### 2-1. QueryProvider ì»´í¬ë„ŒíŠ¸ ìƒì„±

`app/QueryProvider.js` íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤:

```jsx
"use client";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
import { Suspense } from "react";
import { useState } from "react";

// ë¡œë”© ì»´í¬ë„ŒíŠ¸
function LoadingFallback() {
  return (
    <div className="list-bg">
      <div className="loading-skeleton">
        <div className="skeleton-item"></div>
        <div className="skeleton-item"></div>
        <div className="skeleton-item"></div>
      </div>
    </div>
  );
}

export default function QueryProvider({ children }) {
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 60 * 1000, // 1ë¶„
        gcTime: 5 * 60 * 1000, // 5ë¶„
        retry: 2,
        refetchOnWindowFocus: false,
        suspense: true, // Suspense ëª¨ë“œ í™œì„±í™”
      },
    },
  }));

  return (
    <QueryClientProvider client={queryClient}>
      <Suspense fallback={<LoadingFallback />}>
        {children}
      </Suspense>
      {process.env.NODE_ENV === 'development' && (
        <ReactQueryDevtools 
          initialIsOpen={false} 
          buttonPosition="bottom-left"
        />
      )}
    </QueryClientProvider>
  );
}
```

**ğŸ” ì½”ë“œ ì„¤ëª…**:
- `"use client"`: í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì„ì„ ëª…ì‹œ
- `QueryClient`: ì¿¼ë¦¬ ìºì‹œì™€ ì„¤ì •ì„ ê´€ë¦¬
- `useState`: ì»´í¬ë„ŒíŠ¸ê°€ ë¦¬ë Œë”ë§ë˜ì–´ë„ QueryClient ì¸ìŠ¤í„´ìŠ¤ê°€ ì¬ìƒì„±ë˜ì§€ ì•Šë„ë¡ ë³´ì¥
- `defaultOptions`: ì „ì—­ ì¿¼ë¦¬ ì„¤ì •
- `suspense: true`: Suspense ëª¨ë“œ í™œì„±í™”ë¡œ ì„ ì–¸ì  ë¡œë”© ìƒíƒœ ê´€ë¦¬
- `Suspense`: Reactì˜ Suspense ì»´í¬ë„ŒíŠ¸ë¡œ ë¡œë”© ìƒíƒœ ì²˜ë¦¬
- `LoadingFallback`: ë¡œë”© ì¤‘ í‘œì‹œí•  ì»´í¬ë„ŒíŠ¸
- `ReactQueryDevtools`: ê°œë°œ ì¤‘ ì¿¼ë¦¬ ìƒíƒœë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ë„êµ¬
- `process.env.NODE_ENV === 'development'`: ê°œë°œ í™˜ê²½ì—ì„œë§Œ DevTools í™œì„±í™”
- `initialIsOpen={false}`: DevToolsê°€ ì²˜ìŒì— ë‹«íŒ ìƒíƒœë¡œ ì‹œì‘
- `buttonPosition="bottom-left"`: DevTools ë²„íŠ¼ ìœ„ì¹˜ ì„¤ì •

### 2-2. layout.jsì— QueryProvider ì ìš©

`app/layout.js`ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•©ë‹ˆë‹¤:

```jsx
import "./globals.css";
import Link from "next/link";  
import { getServerSession } from "next-auth/next";
import { authOptions } from "@/api/auth/[...nextauth]/route";
import { cookies } from "next/headers";
import LoginBtn from "./LoginBtn";
import LogoutBtn from "./LogoutBtn";
import DarkMode from "./DarkMode";
import SessionProvider from "./SessionProvider";
import QueryProvider from "./QueryProvider"; // ì¶”ê°€

export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default async function RootLayout({ children }) {
  let session = await getServerSession(authOptions);
  let cookie = cookies().get('mode');
  
  return (
    <html lang="en">
      <body className={ 
        cookie != undefined && cookie.value == 'dark'
          ? 'dark-mode'
          : ''
      }>
        <QueryProvider> {/* QueryProviderë¡œ ê°ì‹¸ê¸° */}
          <SessionProvider session={session}>
            <div className="navbar">
              <div>
                <Link href="/" className="logo">
                  BSSMê²Œì‹œíŒ
                </Link>
                <Link href="/list">ëª©ë¡ë³´ê¸°</Link>
              </div>
              <div>
                <DarkMode/>
                {session ? (
                  <span>
                    {session.user.name} <LogoutBtn />
                  </span>
                ) : (
                  <LoginBtn />
                )}
              </div>
            </div>
            {children}
          </SessionProvider>
        </QueryProvider>
      </body>
    </html>
  );
}
```

**ğŸ” ì½”ë“œ ì„¤ëª…**:
- `QueryProvider`ê°€ `SessionProvider`ë¥¼ ê°ì‹¸ë„ë¡ ë°°ì¹˜
- ëª¨ë“  í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ì—ì„œ TanStack Queryë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

---

## 3ë‹¨ê³„: ì¿¼ë¦¬ ìœ í‹¸ë¦¬í‹° ìƒì„±

### 3-1. ì¿¼ë¦¬ í‚¤ì™€ fetcher í•¨ìˆ˜ ì •ì˜

`app/lib/queries/postQueries.js` íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤:

```js
// ì¿¼ë¦¬ í‚¤ ì •ì˜ - ë‹¨ì¼ í‚¤ ë°°ì—´ ì‚¬ìš© (ê°„ë‹¨ ë²„ì „)
export const postListKey = ["posts"];

// ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ
export async function fetchPostList() {
  const res = await fetch("/api/list", { 
    cache: "no-store",
    headers: {
      'Content-Type': 'application/json',
    }
  });
  
  if (!res.ok) {
    throw new Error(`Failed to fetch post list: ${res.status}`);
  }
  
  return res.json();
}

// ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ
export async function fetchPostDetail(id) {
  const res = await fetch(`/api/post/${id}`, {
    cache: "no-store",
    headers: {
      'Content-Type': 'application/json',
    }
  });
  
  if (!res.ok) {
    throw new Error(`Failed to fetch post detail: ${res.status}`);
  }
  
  return res.json();
}

// ê²Œì‹œê¸€ ìƒì„±
export async function createPost(data) {
  const formData = new FormData();
  formData.append('title', data.title);
  formData.append('content', data.content);
  
  const res = await fetch("/api/post/new", {
    method: "POST",
    body: formData,
  });
  
  if (!res.ok) {
    throw new Error(`Failed to create post: ${res.status}`);
  }
  
  return res.json();
}

// ê²Œì‹œê¸€ ìˆ˜ì •
export async function updatePost(id, data) {
  const res = await fetch(`/api/post/edit`, {
    method: "PUT",
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ id, ...data }),
  });
  
  if (!res.ok) {
    throw new Error(`Failed to update post: ${res.status}`);
  }
  
  return res.json();
}

// ê²Œì‹œê¸€ ì‚­ì œ
export async function deletePost(id) {
  const res = await fetch(`/api/post/${id}`, {
    method: "DELETE",
    headers: {
      'Content-Type': 'application/json',
    }
  });
  
  if (!res.ok) {
    throw new Error(`Failed to delete post: ${res.status}`);
  }
  
  return res.json();
}
```

**ğŸ” ì½”ë“œ ì„¤ëª…**:
- `postList`: ëª©ë¡ ì¡°íšŒì— ì‚¬ìš©í•˜ëŠ” ë‹¨ì¼ ì¿¼ë¦¬ í‚¤ ë°°ì—´
- ê° fetcher í•¨ìˆ˜ëŠ” ì—ëŸ¬ ì²˜ë¦¬ë¥¼ í¬í•¨
- `cache: "no-store"`: ì„œë²„ ì‚¬ì´ë“œ ìºì‹± ë¹„í™œì„±í™”
- `FormData`: íŒŒì¼ ì—…ë¡œë“œë‚˜ í¼ ë°ì´í„° ì „ì†¡ì— ì í•©

### 3-2. API ë¼ìš°íŠ¸ í™•ì¸

ê¸°ì¡´ APIê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. `app/api/list/route.js`ê°€ ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³ , ì—†ë‹¤ë©´ ìƒì„±í•©ë‹ˆë‹¤:

```js
// app/api/list/route.js
import { connectDB } from "@/util/database";
import { NextResponse } from "next/server";

export async function GET() {
  try {
    const db = (await connectDB).db("forum");
    const result = await db.collection("post").find().toArray();
    
    // ObjectIdë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
    const resultStr = result.map(item => ({
      ...item,
      _id: item._id.toString(),
    }));
    
    return NextResponse.json(resultStr);
  } catch (error) {
    console.error("DB ì ‘ì† ì—ëŸ¬:", error);
    return NextResponse.json({ error: "DB ì ‘ì† ì—ëŸ¬" }, { status: 500 });
  }
}
```

---

## 4ë‹¨ê³„: ê²Œì‹œê¸€ ëª©ë¡ ì»´í¬ë„ŒíŠ¸ êµ¬í˜„

### 4-1. ListClient ì»´í¬ë„ŒíŠ¸ ìƒì„±

`app/list/ListClient.js` íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤:

```jsx
"use client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { postList, fetchPostList, deletePost } from "@/lib/queries/postQueries";
import ListItem from "./ListItem";
import { ErrorBoundary } from "react-error-boundary";

// ì—ëŸ¬ í´ë°± ì»´í¬ë„ŒíŠ¸
function ErrorFallback({ error, resetErrorBoundary }) {
  return (
    <div className="list-bg">
      <div className="error-message">
        <h3>ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h3>
        <p>{error?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}</p>
        <button 
          onClick={resetErrorBoundary}
          className="retry-btn"
        >
          ë‹¤ì‹œ ì‹œë„
        </button>
      </div>
    </div>
  );
}

// ë©”ì¸ ì»´í¬ë„ŒíŠ¸ (Suspenseì™€ í˜¸í™˜)
function ListContent() {
  const queryClient = useQueryClient();

  // ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (Suspense ëª¨ë“œ)
  const { data: posts } = useQuery({
    queryKey: postList,
    queryFn: fetchPostList,
    staleTime: 30_000, // 30ì´ˆ
    gcTime: 5 * 60_000, // 5ë¶„
    suspense: true, // Suspense ëª¨ë“œ í™œì„±í™”
  });

  // ì‚­ì œ mutation
  const deleteMutation = useMutation({
    mutationFn: deletePost,
    onSuccess: () => {
      // ì‚­ì œ ì„±ê³µ ì‹œ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
      queryClient.invalidateQueries({ queryKey: postListKey});
    },
    onError: (error) => {
      alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
    },
  });

  // ì‚­ì œ í•¸ë“¤ëŸ¬
  const handleDelete = (id) => {
    if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      deleteMutation.mutate(id);
    }
  };

  return (
    <div className="list-bg">
      {posts?.length === 0 ? (
        <div className="empty-state">
          <h3>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì²« ë²ˆì§¸ ê²Œì‹œê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
        </div>
      ) : (
        posts?.map((item) => (
          <ListItem 
            key={item._id} 
            item={item} 
            onDelete={handleDelete}
            isDeleting={deleteMutation.isPending}
          />
        ))
      )}
    </div>
  );
}

export default function ListClient() {
  return (
    <ErrorBoundary
      FallbackComponent={ErrorFallback}
      onReset={() => {
        // ì—ëŸ¬ ë¦¬ì…‹ ì‹œ ì¿¼ë¦¬ ìºì‹œ í´ë¦¬ì–´
        window.location.reload();
      }}
    >
      <ListContent />
    </ErrorBoundary>
  );
}
```

**ğŸ” ì½”ë“œ ì„¤ëª…**:
- `useQuery`: ë°ì´í„° ì¡°íšŒì™€ ìºì‹± ê´€ë¦¬
- `suspense: true`: Suspense ëª¨ë“œë¡œ ì„ ì–¸ì  ë¡œë”© ìƒíƒœ ê´€ë¦¬
- `useMutation`: ë°ì´í„° ë³€ê²½ ì‘ì—… (ì‚­ì œ)
- `queryClient.invalidateQueries`: íŠ¹ì • ì¿¼ë¦¬ ë¬´íš¨í™”í•˜ì—¬ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ì—¬ê¸°ì„œëŠ” `postList`)
- `ErrorBoundary`: ì—ëŸ¬ ë°œìƒ ì‹œ í´ë°± UI í‘œì‹œ
- `ErrorFallback`: ì—ëŸ¬ ìƒíƒœì—ì„œ í‘œì‹œí•  ì»´í¬ë„ŒíŠ¸
- `ListContent`: ì‹¤ì œ ë°ì´í„°ë¥¼ ë Œë”ë§í•˜ëŠ” ì»´í¬ë„ŒíŠ¸
- ë¡œë”© ìƒíƒœëŠ” Suspenseê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬

### 4-2. ListItem ì»´í¬ë„ŒíŠ¸ ìˆ˜ì •

`app/list/ListItem.js`ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•©ë‹ˆë‹¤:

```jsx
"use client";
import Link from "next/link";

export default function ListItem({item, onDelete, isDeleting}) {
  return (
    <div className="list-item-card">
      <div className="list-item-header">
        <Link href={"/detail/" + item._id} className="list-item-title-link">
          <h4 className="list-item-title">{item.title}</h4>
        </Link>
      </div>
      <div className="list-item-actions">
        <button className="list-btn edit-btn">
          <Link href={"/edit/" + item._id}>ìˆ˜ì •</Link>
        </button>
        <button
          className="list-btn delete-btn"
          onClick={() => onDelete(item._id)}
          disabled={isDeleting}
        >
          {isDeleting ? "ì‚­ì œì¤‘..." : "ì‚­ì œ"}
        </button>
      </div>
      <p className="list-item-content">{item.content}</p> 
      <p className="list-item-content">{item.author}</p> 
    </div>
  );
}
```

### 4-3. list/page.js ìˆ˜ì •

`app/list/page.jsx`ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•©ë‹ˆë‹¤:

```jsx
import ListClient from "./ListClient";

//ì£¼ìš”ê¸°ëŠ¥
//1. TanStack Queryë¥¼ ì‚¬ìš©í•œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë°ì´í„° íŒ¨ì¹­
//2. ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ë¡œ ìœ„ì„

export default function List() {
  return (
    <div className="list-page-container">
      <h2 className="list-page-title">ê²Œì‹œê¸€ ëª©ë¡</h2>
      <ListClient />
    </div>
  );
}
```

---

## 5ë‹¨ê³„: ê²Œì‹œê¸€ ì‘ì„± ê¸°ëŠ¥ êµ¬í˜„

### 5-1. WriteClient ì»´í¬ë„ŒíŠ¸ ìƒì„±

`app/write/WriteClient.js` íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤:

```jsx
"use client";
import { useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { postList, createPost } from "@/lib/queries/postQueries";
import { useRouter } from "next/navigation";

export default function WriteClient() {
  const [formData, setFormData] = useState({
    title: "",
    content: "",
  });
  const router = useRouter();
  const queryClient = useQueryClient();

  // ê²Œì‹œê¸€ ìƒì„± mutation
  const createMutation = useMutation({
    mutationFn: createPost,
    onSuccess: () => {
      // ì„±ê³µ ì‹œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨í•˜ê³  ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
      queryClient.invalidateQueries({ queryKey: postList });
      router.push("/list");
    },
    onError: (error) => {
      alert(`ê²Œì‹œê¸€ ì‘ì„± ì‹¤íŒ¨: ${error.message}`);
    },
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    
    if (!formData.title.trim()) {
      alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    
    if (!formData.content.trim()) {
      alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    createMutation.mutate(formData);
  };

  const handleChange = (e) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value,
    });
  };

  return (
    <div className="write-form-container">
      <h4 className="write-form-title">ê¸€ì‘ì„±</h4>
      <form onSubmit={handleSubmit} className="write-form">
        <input
          type="text"
          name="title"
          placeholder="ê¸€ì œëª©"
          className="write-input"
          value={formData.title}
          onChange={handleChange}
          disabled={createMutation.isPending}
        />
        <input
          type="text"
          name="content"
          placeholder="ê¸€ë‚´ìš©"
          className="write-input"
          value={formData.content}
          onChange={handleChange}
          disabled={createMutation.isPending}
        />
        <button 
          type="submit" 
          className="write-btn"
          disabled={createMutation.isPending}
        >
          {createMutation.isPending ? "ì‘ì„±ì¤‘..." : "ì‘ì„±í•˜ê¸°"}
        </button>
      </form>
    </div>
  );
}
```

### 5-2. write/page.js ìˆ˜ì •

`app/write/page.js`ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•©ë‹ˆë‹¤:

```jsx
import WriteClient from "./WriteClient";

export default function Write(){
  return <WriteClient />;
}
```

### 5-3. API ë¼ìš°íŠ¸ ìˆ˜ì •

`app/api/post/new/route.js`ë¥¼ JSON ì‘ë‹µì„ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤:

```js
import { authOptions } from "@/api/auth/[...nextauth]/route";
import { connectDB } from "@/util/database.js";
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";

export async function POST(request) {
  let session = await getServerSession(authOptions);
  
  try {
    const formData = await request.formData();
    let body = Object.fromEntries(formData.entries());
    
    if (session) {
      body.author = session.user.email;
    }

    if (!body.title || body.title.trim() === "") {
      return NextResponse.json("ì œëª©ì„ ì”ì‹œë‹¤", { status: 500 });
    }

    const db = (await connectDB).db("forum");
    const result = await db.collection("post").insertOne(body);

    // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ JSON ì‘ë‹µ ë°˜í™˜
    return NextResponse.json({ 
      success: true, 
      message: "ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.",
      id: result.insertedId 
    });
  } catch (error) {
    console.error(error);
    return NextResponse.json("ì„œë²„ ì˜¤ë¥˜", { status: 500 });
  }
}
```

---

## 6ë‹¨ê³„: ìŠ¤íƒ€ì¼ë§ ë° UX ê°œì„ 

### 6-1. CSS ìŠ¤íƒ€ì¼ ì¶”ê°€

`app/globals.css`ì— ë‹¤ìŒ ìŠ¤íƒ€ì¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤:

```css
/* TanStack Query ê´€ë ¨ ìŠ¤íƒ€ì¼ */
.loading-skeleton {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.skeleton-item {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  height: 80px;
  border-radius: 8px;
}

@keyframes loading {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

.error-message {
  text-align: center;
  padding: 40px 20px;
  background: #fff5f5;
  border: 1px solid #fed7d7;
  border-radius: 8px;
  color: #c53030;
}

.error-message h3 {
  margin-bottom: 10px;
  font-size: 18px;
}

.error-message p {
  margin-bottom: 20px;
  color: #718096;
}

.retry-btn {
  background: #3182ce;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.retry-btn:hover {
  background: #2c5aa0;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #718096;
}

.empty-state h3 {
  margin-bottom: 10px;
  font-size: 20px;
  color: #4a5568;
}

.empty-state p {
  font-size: 16px;
}
```

### 6-2. ìºì‹œ ì „ëµ ìµœì í™”

QueryProviderì—ì„œ ì„¤ì •í•œ ê¸°ë³¸ê°’ë“¤:

```js
defaultOptions: {
  queries: {
    staleTime: 60 * 1000, // 1ë¶„ - ë°ì´í„°ê°€ ì‹ ì„ í•œ ìƒíƒœë¡œ ìœ ì§€ë˜ëŠ” ì‹œê°„
    gcTime: 5 * 60 * 1000, // 5ë¶„ - ìºì‹œì—ì„œ ì œê±°ë˜ê¸°ê¹Œì§€ì˜ ì‹œê°„
    retry: 2, // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íšŸìˆ˜
    refetchOnWindowFocus: false, // ì°½ í¬ì»¤ìŠ¤ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨ ë¹„í™œì„±í™”
  },
}
```

**ğŸ” ìºì‹œ ì „ëµ ì„¤ëª…**:
- `staleTime`: ë°ì´í„°ê°€ ì‹ ì„ í•œ ìƒíƒœë¡œ ìœ ì§€ë˜ëŠ” ì‹œê°„
- `gcTime`: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë°ì´í„°ê°€ ë©”ëª¨ë¦¬ì—ì„œ ì œê±°ë˜ëŠ” ì‹œê°„
- `retry`: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ìë™ ì¬ì‹œë„
- `refetchOnWindowFocus`: ì‚¬ìš©ìê°€ ë‹¤ë¥¸ íƒ­ì—ì„œ ëŒì•„ì˜¬ ë•Œ ìë™ ìƒˆë¡œê³ ì¹¨

### 6-3. Suspenseì™€ Error Boundary í™œìš©

#### Suspenseì˜ ì¥ì :
- **ì„ ì–¸ì  ë¡œë”© ìƒíƒœ**: `isLoading` ìƒíƒœë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•  í•„ìš” ì—†ìŒ
- **ìë™ ë¡œë”© UI**: Suspenseê°€ ìë™ìœ¼ë¡œ fallback ì»´í¬ë„ŒíŠ¸ í‘œì‹œ
- **ë” ê¹”ë”í•œ ì½”ë“œ**: ì¡°ê±´ë¶€ ë Œë”ë§ ë¡œì§ ì œê±°
- **ì¼ê´€ëœ UX**: ëª¨ë“  ì¿¼ë¦¬ì—ì„œ ë™ì¼í•œ ë¡œë”© ê²½í—˜

#### Error Boundaryì˜ ì¥ì :
- **ì—ëŸ¬ ê²©ë¦¬**: í•œ ì»´í¬ë„ŒíŠ¸ì˜ ì—ëŸ¬ê°€ ì „ì²´ ì•±ì„ ì¤‘ë‹¨ì‹œí‚¤ì§€ ì•ŠìŒ
- **ì‚¬ìš©ì ì¹œí™”ì **: ì—ëŸ¬ ë°œìƒ ì‹œ ì ì ˆí•œ í´ë°± UI ì œê³µ
- **ì—ëŸ¬ ë³µêµ¬**: ì‚¬ìš©ìê°€ ì—ëŸ¬ì—ì„œ ë³µêµ¬í•  ìˆ˜ ìˆëŠ” ë°©ë²• ì œê³µ

#### Suspense vs ì „í†µì  ë°©ì‹ ë¹„êµ:

**ì „í†µì  ë°©ì‹**:
```jsx
const { data, isLoading, isError, error } = useQuery({...});

if (isLoading) return <Loading />;
if (isError) return <Error error={error} />;
return <Data data={data} />;
```

**Suspense ë°©ì‹**:
```jsx
// ë¡œë”©ê³¼ ì—ëŸ¬ëŠ” ìƒìœ„ì—ì„œ ì²˜ë¦¬
const { data } = useQuery({ suspense: true, ... });
return <Data data={data} />;
```

### 6-4. DevTools ì‚¬ìš©ë²•

TanStack Query DevToolsë¥¼ ì‚¬ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì •ë³´ë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

#### DevTools ê¸°ëŠ¥:
- **ì¿¼ë¦¬ ìƒíƒœ**: ê° ì¿¼ë¦¬ì˜ ë¡œë”©, ì„±ê³µ, ì—ëŸ¬ ìƒíƒœ
- **ìºì‹œ ë°ì´í„°**: í˜„ì¬ ìºì‹œì— ì €ì¥ëœ ë°ì´í„°
- **ì¿¼ë¦¬ í‚¤**: ì‚¬ìš© ì¤‘ì¸ ì¿¼ë¦¬ í‚¤ë“¤
- **ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸**: ì¿¼ë¦¬ ìƒíƒœ ë³€í™”ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸
- **ìˆ˜ë™ ì¡°ì‘**: ì¿¼ë¦¬ ë¬´íš¨í™”, ì¬ì‹œë„ ë“± ìˆ˜ë™ ì¡°ì‘ ê°€ëŠ¥

#### DevTools ì‚¬ìš© ë°©ë²•:
1. ê°œë°œ ì„œë²„ ì‹¤í–‰ í›„ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸
2. í™”ë©´ ì™¼ìª½ í•˜ë‹¨ì— React Query ì•„ì´ì½˜ í´ë¦­
3. ì¿¼ë¦¬ ëª©ë¡ì—ì„œ ê° ì¿¼ë¦¬ ìƒíƒœ í™•ì¸
4. ì¿¼ë¦¬ í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ ë° ë°ì´í„° í™•ì¸

#### í”„ë¡œë•ì…˜ì—ì„œ DevTools ë¹„í™œì„±í™”:
```jsx
// í”„ë¡œë•ì…˜ì—ì„œëŠ” DevToolsë¥¼ ë¹„í™œì„±í™”
<ReactQueryDevtools 
  initialIsOpen={false} 
  buttonPosition="bottom-left"
  // í”„ë¡œë•ì…˜ì—ì„œëŠ” ì¡°ê±´ë¶€ ë Œë”ë§
  {...(process.env.NODE_ENV === 'development' && {})}
/>
```

---

## 7ë‹¨ê³„: ê³ ê¸‰ ê¸°ëŠ¥ (ì„ íƒì‚¬í•­)

### 7-1. SSR Prefetch + Hydration

ì²« í˜ì¸íŠ¸ë¥¼ ë” ë¹ ë¥´ê²Œ í•˜ë ¤ë©´ ì„œë²„ì—ì„œ ë¯¸ë¦¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```jsx
// app/list/page.js (ì„œë²„)
import { dehydrate, HydrationBoundary, QueryClient } from "@tanstack/react-query";
import ListClient from "./ListClient";
import { postList, fetchPostList } from "@/lib/queries/postQueries";

export default async function Page() {
  const queryClient = new QueryClient();
  await queryClient.prefetchQuery({ 
    queryKey: postList, 
    queryFn: fetchPostList 
  });
  const state = dehydrate(queryClient);
  
  return (
    <HydrationBoundary state={state}>
      <ListClient />
    </HydrationBoundary>
  );
}
```

### 7-2. íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ì§€ì› (ì„ íƒ)

TypeScriptë¥¼ ì‚¬ìš©í•œë‹¤ë©´ íƒ€ì…ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```ts
// types/post.ts
interface PostItem { 
  _id: string; 
  title: string; 
  content: string; 
  author?: string;
  createdAt?: string;
}

// ì‚¬ìš© ì˜ˆì‹œ
const { data } = useQuery<PostItem[]>({ 
  queryKey: postQueryKeys.lists(), 
  queryFn: fetchPostList 
});
```

---

## 8ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

### 8-1. ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ê²Œì‹œê¸€ ëª©ë¡ì´ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ëŠ”ê°€?
- [ ] ë¡œë”© ìƒíƒœê°€ ìŠ¤ì¼ˆë ˆí†¤ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ê°€?
- [ ] ì—ëŸ¬ ë°œìƒ ì‹œ ì¬ì‹œë„ ë²„íŠ¼ì´ ì‘ë™í•˜ëŠ”ê°€?
- [ ] ê²Œì‹œê¸€ ì‚­ì œê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ê°€?
- [ ] ê²Œì‹œê¸€ ì‘ì„± í›„ ëª©ë¡ì´ ìë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ëŠ”ê°€?
- [ ] ë¹ˆ ìƒíƒœê°€ ì ì ˆíˆ í‘œì‹œë˜ëŠ”ê°€?

### 8-2. ì„±ëŠ¥ í™•ì¸

- [ ] ë„¤íŠ¸ì›Œí¬ íƒ­ì—ì„œ ë¶ˆí•„ìš”í•œ ì¤‘ë³µ ìš”ì²­ì´ ì—†ëŠ”ê°€?
- [ ] ìºì‹œê°€ ì ì ˆíˆ ì‘ë™í•˜ëŠ”ê°€?
- [ ] í˜ì´ì§€ ì „í™˜ ì‹œ ë°ì´í„°ê°€ ì¦‰ì‹œ í‘œì‹œë˜ëŠ”ê°€?

---

## 9ë‹¨ê³„: ë°°í¬ ë° ìµœì í™”

### 9-1. í”„ë¡œë•ì…˜ ìµœì í™”

```js
// QueryProvider ìµœì í™”
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5ë¶„
      gcTime: 10 * 60 * 1000, // 10ë¶„
      retry: 1, // ì¬ì‹œë„ íšŸìˆ˜ ì¤„ì´ê¸°
      refetchOnWindowFocus: false,
    },
  },
});
```

### 9-2. ì—ëŸ¬ ëª¨ë‹ˆí„°ë§

```js
// ì—ëŸ¬ ë°”ìš´ë”ë¦¬ ì¶”ê°€
import { ErrorBoundary } from 'react-error-boundary';

function ErrorFallback({error, resetErrorBoundary}) {
  return (
    <div role="alert">
      <h2>Something went wrong:</h2>
      <pre>{error.message}</pre>
      <button onClick={resetErrorBoundary}>Try again</button>
    </div>
  )
}
```

---

## ğŸ‰ ì™„ì„±!

ì¶•í•˜í•©ë‹ˆë‹¤! TanStack Queryë¥¼ ì‚¬ìš©í•œ í˜„ëŒ€ì ì¸ Next.js ê²Œì‹œíŒì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

### ğŸ“š í•™ìŠµí•œ ë‚´ìš©

1. **TanStack Query ê¸°ë³¸ ê°œë…**: useQuery, useMutation, QueryClient
2. **Next.js App Router**: ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ ë¶„ë¦¬
3. **ì„ ì–¸ì  ë°ì´í„° íŒ¨ì¹­**: ìƒíƒœ ê´€ë¦¬ ì—†ì´ ë°ì´í„° ì²˜ë¦¬
4. **ìºì‹± ì „ëµ**: staleTime, gcTime ì„¤ì •
5. **ì—ëŸ¬ ì²˜ë¦¬**: ë¡œë”©/ì—ëŸ¬/ë¹ˆ ìƒíƒœ ê´€ë¦¬
6. **CRUD êµ¬í˜„**: ìƒì„±, ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œ ê¸°ëŠ¥

### ğŸš€ ë‹¤ìŒ ë‹¨ê³„

- ìƒì„¸ í˜ì´ì§€ êµ¬í˜„
- ëŒ“ê¸€ ê¸°ëŠ¥ ì¶”ê°€
- í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„
- ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (WebSocket)

### ğŸ“– ì¶”ê°€ í•™ìŠµ ìë£Œ

- [TanStack Query ê³µì‹ ë¬¸ì„œ](https://tanstack.com/query/latest)
- [Next.js App Router ê°€ì´ë“œ](https://nextjs.org/docs/app)
- [React Query íŒ¨í„´ ëª¨ìŒ](https://tkdodo.eu/blog/practical-react-query)

---

**ğŸ’¡ íŒ**: ì´ ê°€ì´ë“œë¥¼ ë”°ë¼í•˜ë©´ì„œ ê° ë‹¨ê³„ë³„ë¡œ ì½”ë“œë¥¼ ì‹¤í–‰í•´ë³´ê³ , ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì˜ ì½˜ì†”ì„ í™•ì¸í•´ë³´ì„¸ìš”!